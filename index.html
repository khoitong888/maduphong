<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Code List & AI Chat</title>
    <script src="https://cdn.tailwindcss.com?plugins=typography"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked@latest/lib/marked.min.js"></script>
    <style>
        body {
            background: linear-gradient(135deg, #4c1d95, #3b82f6, #db2777);
            background-size: 200% 200%;
            animation: gradientShift 15s ease infinite;
            font-family: 'Inter', sans-serif;
            color: #f1f5f9;
            overflow-x: hidden;
            position: relative;
        }

        @keyframes gradientShift {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        canvas#sparkle-canvas {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 0;
        }

        .container {
            background: linear-gradient(145deg, #1e293b, #2d3748);
            border-radius: 20px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.6);
            padding: 2rem;
            margin: 2rem auto;
            position: relative;
            z-index: 1;
        }

        .code-card {
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border-radius: 12px;
            padding: 1rem;
        }

        .code-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4), 0 0 15px rgba(59, 130, 246, 0.5);
        }

        .copy-btn {
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
            font-weight: 500;
        }

        .copy-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .copied::after {
            content: 'Copied!';
            position: absolute;
            right: 10px;
            top: -30px;
            background: #10b981;
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            opacity: 0;
            animation: fadeInOut 1.5s ease;
        }

        @keyframes fadeInOut {
            0% { opacity: 0; transform: translateY(10px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(10px); }
        }

        .reisurrk-section {
            background: linear-gradient(to right, #4b5563, #6b7280);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .reisurk-section {
            background: linear-gradient(to right, #3f3f46, #52525b);
            border-radius: 12px;
            padding: 1.5rem;
        }

        .reisurrk-card {
            background: linear-gradient(to right, #4b5563, #6b7280);
        }

        .reisurk-card {
            background: linear-gradient(to right, #3f3f46, #52525b);
        }

        .reisurrk-btn {
            background: linear-gradient(135deg, #3b82f6, #60a5fa);
        }

        .reisurk-btn {
            background: linear-gradient(135deg, #8b5cf6, #a78bfa);
        }

        .chat-container {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 90%;
            max-width: 450px;
            max-height: 80vh;
            background: rgba(30, 41, 59, 0.2);
            border-radius: 16px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3), 0 0 20px rgba(139, 92, 246, 0.4);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: none;
            flex-direction: column;
            overflow: hidden;
            z-index: 1000;
            transform: scale(0.95);
            opacity: 0;
            transition: transform 0.4s ease, opacity 0.4s ease;
        }

        .chat-container.open {
            display: flex;
            transform: scale(1);
            opacity: 1;
        }

        .chat-header {
            background: linear-gradient(135deg, #6d28d9, #8b5cf6);
            color: white;
            padding: 12px;
            font-weight: 600;
            text-align: center;
            font-size: 1.25rem;
            border-top-left-radius: 16px;
            border-top-right-radius: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 0 15px rgba(139, 92, 246, 0.5);
        }

        .chat-messages {
            flex-grow: 1;
            padding: 16px;
            overflow-y: auto;
            font-size: 0.95rem;
            scroll-behavior: smooth;
            background: rgba(30, 41, 59, 0.3);
            color: #f1f5f9;
            backdrop-filter: blur(10px);
        }

        .chat-message {
            margin-bottom: 20px;
            padding: 12px 16px;
            border-radius: 12px;
            position: relative;
            animation: slideIn 0.3s ease;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.25);
        }

        @keyframes slideIn {
            from { transform: translateY(20px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .user-message {
            background: rgba(30, 64, 175, 0.7);
            margin-left: 25%;
            text-align: right;
            color: #f1f5f9;
            position: relative;
            backdrop-filter: blur(8px);
        }

        .user-message::before {
            content: attr(data-sender);
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #93c5fd;
            margin-bottom: 6px;
        }

        .bot-message {
            background: rgba(75, 85, 99, 0.7);
            margin-right: 25%;
            text-align: left;
            color: #f1f5f9;
            position: relative;
            backdrop-filter: blur(8px);
        }

        .bot-message::before {
            content: attr(data-sender);
            display: block;
            font-size: 0.75rem;
            font-weight: 600;
            color: #a5b4fc;
            margin-bottom: 6px;
        }

        .favorite-btn {
            background: none;
            border: none;
            cursor: pointer;
            color: #f1f5f9;
            font-size: 0.9rem;
            margin-left: 8px;
            transition: color 0.2s ease, transform 0.2s ease;
        }

        .favorite-btn:hover {
            color: #f59e0b;
            transform: scale(1.2);
        }

        .favorite {
            color: #f59e0b;
        }

        .message-time {
            font-size: 0.7rem;
            color: #94a3b8;
            margin-top: 6px;
            opacity: 0.8;
        }

        .chat-input {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 12px;
            background: rgba(15, 23, 42, 0.2);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .chat-input input[type="text"] {
            flex-grow: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: rgba(30, 41, 59, 0.5);
            color: #f1f5f9;
            transition: box-shadow 0.3s ease;
        }

        .chat-input input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 8px rgba(167, 139, 250, 0.6);
        }

        .chat-input .input-group {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .chat-input input[type="file"] {
            display: none;
        }

        .chat-input label {
            background: linear-gradient(135deg, #475569, #64748b);
            color: white;
            padding: 8px 12px;
            border-radius: 10px;
            cursor: pointer;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .chat-input label:hover {
            background: linear-gradient(135deg, #64748b, #94a3b8);
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.5);
        }

        .chat-input button {
            background: linear-gradient(135deg, #6d28d9, #8b5cf6);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease, box-shadow 0.3s ease;
        }

        .chat-input button:hover {
            background: linear-gradient(135deg, #5b21b6, #7c3aed);
            box-shadow: 0 0 10px rgba(139, 92, 246, 0.6);
        }

        .chat-input button:disabled {
            background: #4b5563;
            cursor: not-allowed;
            box-shadow: none;
        }

        .chat-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #6d28d9, #8b5cf6);
            color: white;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5), 0 0 15px rgba(139, 92, 246, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            z-index: 1001;
        }

        .chat-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0, 0, 0, 0.6), 0 0 20px rgba(139, 92, 246, 0.7);
        }

        .chat-toggle img {
            width: 32px;
            height: 32px;
            object-fit: contain;
        }

        .image-preview {
            max-width: 100%;
            max-height: 150px;
            border-radius: 10px;
            margin-top: 8px;
            display: none;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.3);
        }

        .loading-spinner {
            display: none;
            width: 20px;
            height: 20px;
            border: 2px solid #ffffff;
            border-top: 2px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading .loading-spinner {
            display: inline-block;
        }

        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #10b981, #34d399);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            z-index: 2000;
            opacity: 0;
            transform: translateY(-20px);
            animation: toastInOut 3s ease;
            box-shadow: 0 0 10px rgba(16, 185, 129, 0.6);
        }

        @keyframes toastInOut {
            0% { opacity: 0; transform: translateY(-20px); }
            20% { opacity: 1; transform: translateY(0); }
            80% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(-20px); }
        }

        pre {
            background: rgba(15, 23, 42, 0.5);
            padding: 12px;
            border-radius: 10px;
            overflow-x: auto;
            color: #e2e8f0;
            font-size: 0.9rem;
            box-shadow: 0 0 10px rgba(59, 130, 246, 0.3);
            backdrop-filter: blur(8px);
        }

        code {
            font-family: 'Fira Code', monospace;
            color: #e2e8f0;
            text-shadow: 0 0 5px rgba(59, 130, 246, 0.5);
        }

        .typing-indicator {
            color: #94a3b8;
            font-style: italic;
            margin-bottom: 16px;
            padding: 12px;
            font-size: 0.9rem;
            text-shadow: 0 0 5px rgba(139, 92, 246, 0.3);
        }

        @media (max-width: 768px) {
            .container {
                padding: 1.5rem;
                margin: 1.5rem;
            }
            .chat-container {
                width: 95%;
                top: 70px;
                right: 10px;
                max-height: 70vh;
            }
            .chat-toggle {
                width: 50px;
                height: 50px;
                top: 10px;
                right: 10px;
            }
            .chat-toggle img {
                width: 28px;
                height: 28px;
            }
        }

        @media (max-width: 480px) {
            .container {
                padding: 1rem;
                margin: 1rem;
            }
            .chat-container {
                width: 100%;
                top: 60px;
                right: 0;
                left: 0;
                margin: 0 auto;
                max-width: none;
            }
            .chat-toggle {
                width: 45px;
                height: 45px;
                top: 10px;
                right: 10px;
            }
            .chat-toggle img {
                width: 24px;
                height: 24px;
            }
            .chat-messages {
                font-size: 0.9rem;
            }
            .chat-header {
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">
    <canvas id="sparkle-canvas"></canvas>
    <div class="container max-w-4xl w-full rounded-lg">
        <h1 class="text-3xl font-bold text-center text-slate-100 mb-8" id="page-title">Code List</h1>

        <!-- Danh s√°ch reisurrk -->
        <div class="mb-10 reisurrk-section">
            <h2 class="text-2xl font-semibold text-blue-300 mb-4" id="reisurrk-title">Reisurrk Codes</h2>
            <div class="space-y-4" id="reisurrk-list"></div>
        </div>

        <!-- Danh s√°ch reisurk -->
        <div class="reisurk-section">
            <h2 class="text-2xl font-semibold text-purple-300 mb-4" id="reisurk-title">Reisurk Codes</h2>
            <div class="space-y-4" id="reisurk-list"></div>
        </div>
    </div>

    <!-- Chat UI -->
    <div class="chat-toggle" onclick="window.toggleChat()">
        <img src="https://via.placeholder.com/32?text=AI" alt="Chat Logo">
    </div>
    <div class="chat-container" id="chat-container">
        <div class="chat-header">
            <span id="chat-header-title">Chat with Beta AI</span>
            <div>
                <select id="language-select" class="bg-transparent text-white text-sm">
                    <option value="vi">Ti·∫øng Vi·ªát</option>
                    <option value="en">English</option>
                </select>
                <button onclick="window.clearChatHistory()" class="text-sm text-white hover:text-gray-300 ml-2" id="clear-history-btn">Clear History</button>
            </div>
        </div>
        <div class="chat-messages" id="chat-messages"></div>
        <div class="chat-input">
            <input type="text" id="chat-input" placeholder="Enter your question or paste an image...">
            <div class="input-group">
                <label for="image-input">üì∑ Upload Image</label>
                <input type="file" id="image-input" accept="image/*">
                <button onclick="sendMessage()" id="send-btn">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M2.003 5.884L10 9.882l7.997-3.998A2 2 0 0016 4H4a2 2 0 00-1.997 1.884z" />
                        <path d="M18 8.118l-8 4-8-4V14a2 2 0 002 2h12a2 2 0 002-2V8.118z" />
                    </svg>
                    <span class="loading-spinner"></span>
                </button>
            </div>
            <img id="image-preview" class="image-preview" alt="Image Preview">
        </div>
    </div>

    <script>
        // Sparkle effect
        const canvas = document.getElementById('sparkle-canvas');
        const ctx = canvas.getContext('2d');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;

        const particles = [];
        function createParticle() {
            return {
                x: Math.random() * canvas.width,
                y: Math.random() * canvas.height,
                size: Math.random() * 3 + 1,
                speedX: Math.random() * 0.5 - 0.25,
                speedY: Math.random() * 0.5 - 0.25,
                opacity: Math.random() * 0.5 + 0.3
            };
        }

        for (let i = 0; i < 50; i++) {
            particles.push(createParticle());
        }

        function animateParticles() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            particles.forEach(p => {
                ctx.fillStyle = `rgba(255, 255, 255, ${p.opacity})`;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2);
                ctx.fill();
                p.x += p.speedX;
                p.y += p.speedY;
                if (p.x < 0 || p.x > canvas.width || p.y < 0 || p.y > canvas.height) {
                    Object.assign(p, createParticle());
                }
            });
            requestAnimationFrame(animateParticles);
        }

        window.addEventListener('resize', () => {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
        });
        animateParticles();

        // Ki·ªÉm tra marked
        if (typeof marked === 'undefined') {
            console.error('Marked library not loaded.');
            alert('Error: Could not load marked library.');
        }

        // ƒê·ªãnh nghƒ©a c√°c h√†m to√†n c·ª•c
        window.clearChatHistory = function() {
            chatHistory = [];
            chatMessages.innerHTML = '';
            imagePreview.style.display = 'none';
            selectedImage = null;
            saveChatHistory();
            showToast(languageSelect.value === 'en' ? 'Chat history cleared!' : 'ƒê√£ x√≥a l·ªãch s·ª≠ tr√≤ chuy·ªán!');
        };

        window.toggleFavoriteByIndex = function(index) {
            const message = chatHistory[index];
            if (message) {
                toggleFavorite(message);
            }
        };

        window.toggleChat = function() {
            chatContainer.classList.toggle('open');
        };

        const codes = [
            { code: 't0dc06uki', name: 'reisurrk' },
            { code: '8p4fxqil0', name: 'reisurrk' },
            { code: '5yhznopjd', name: 'reisurrk' },
            { code: 'bwjxei2tc', name: 'reisurrk' },
            { code: '20pmgzx43', name: 'reisurrk' },
            { code: 'hsoqpf6nd', name: 'reisurrk' },
            { code: 'le5uxv8w3', name: 'reisurrk' },
            { code: 'xdsde8vch', name: 'reisurrk' },
            { code: 'kuhu5bovm', name: 'reisurrk' },
            { code: '9cuyoqhvm', name: 'reisurrk' },
            { code: 'l1w0lqp31', name: 'reisurk' },
            { code: 'nwy4ede0s', name: 'reisurk' },
            { code: '1887uitjs', name: 'reisurk' },
            { code: '94yrnjakx', name: 'reisurk' },
            { code: 'sc44no9g9', name: 'reisurk' },
            { code: '36z930090', name: 'reisurk' },
            { code: 'a9g5k0tel', name: 'reisurk' },
            { code: 'rsroh6xoz', name: 'reisurk' },
            { code: 'bhipk4nss', name: 'reisurk' },
            { code: 'rfwajh3g0', name: 'reisurk' }
        ];

        const reisurrkList = document.getElementById('reisurrk-list');
        const reisurkList = document.getElementById('reisurk-list');
        const chatContainer = document.getElementById('chat-container');
        const chatMessages = document.getElementById('chat-messages');
        const chatInput = document.getElementById('chat-input');
        const imageInput = document.getElementById('image-input');
        const imagePreview = document.getElementById('image-preview');
        const sendBtn = document.getElementById('send-btn');
        const languageSelect = document.getElementById('language-select');
        const chatHeaderTitle = document.getElementById('chat-header-title');
        const clearHistoryBtn = document.getElementById('clear-history-btn');
        const pageTitle = document.getElementById('page-title');
        const reisurrkTitle = document.getElementById('reisurrk-title');
        const reisurkTitle = document.getElementById('reisurk-title');

        let chatHistory = JSON.parse(localStorage.getItem('chatHistory')) || [];
        let favorites = JSON.parse(localStorage.getItem('favorites')) || [];
        let selectedImage = null;
        let isProcessing = false;

        // ƒê·∫£m b·∫£o favorites l√† m·∫£ng
        if (!Array.isArray(favorites)) {
            favorites = [];
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }

        function updateLanguageUI() {
            const lang = languageSelect.value;
            pageTitle.textContent = lang === 'en' ? 'Code List' : 'Danh s√°ch m√£';
            reisurrkTitle.textContent = lang === 'en' ? 'Reisurrk Codes' : 'M√£ reisurrk';
            reisurkTitle.textContent = lang === 'en' ? 'Reisurk Codes' : 'M√£ reisurk';
            chatHeaderTitle.textContent = lang === 'en' ? 'Chat with Beta AI' : 'Chat v·ªõi Beta AI';
            clearHistoryBtn.textContent = lang === 'en' ? 'Clear History' : 'X√≥a l·ªãch s·ª≠';
            chatInput.placeholder = lang === 'en' ? 'Enter your question or paste an image...' : 'Nh·∫≠p c√¢u h·ªèi ho·∫∑c d√°n ·∫£nh...';
            document.querySelector('label[for="image-input"]').textContent = lang === 'en' ? 'üì∑ Upload Image' : 'üì∑ T·∫£i ·∫£nh';
            loadChatHistory();
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function renderCodes() {
            reisurrkList.innerHTML = '';
            reisurkList.innerHTML = '';
            const lang = languageSelect.value;
            codes.forEach(item => {
                const div = document.createElement('div');
                div.className = `code-card flex items-center justify-between p-4 rounded-lg ${item.name === 'reisurrk' ? 'reisurrk-card' : 'reisurk-card'}`;
                div.innerHTML = `
                    <code class="text-lg font-mono text-slate-200 bg-gray-800 px-3 py-1 rounded">${item.code}</code>
                    <button class="copy-btn ${item.name === 'reisurrk' ? 'reisurrk-btn' : 'reisurk-btn'} text-white px-4 py-2 rounded-lg" onclick="copyToClipboard('${item.code}', this)">${lang === 'en' ? 'Copy' : 'Sao ch√©p'}</button>
                `;
                if (item.name === 'reisurrk') {
                    reisurrkList.appendChild(div);
                } else {
                    reisurkList.appendChild(div);
                }
            });
        }

        function copyToClipboard(text, button) {
            navigator.clipboard.writeText(text).then(() => {
                button.classList.add('copied', 'bg-green-500');
                showToast(languageSelect.value === 'en' ? 'Code copied!' : 'ƒê√£ sao ch√©p m√£!');
                setTimeout(() => {
                    button.classList.remove('copied', 'bg-green-500');
                    button.classList.add(button.classList.contains('reisurrk-btn') ? 'reisurrk-btn' : 'reisurk-btn');
                }, 1500);
            }).catch(err => {
                console.error('Copy error:', err);
                showToast(languageSelect.value === 'en' ? 'Copy failed!' : 'L·ªói khi sao ch√©p!');
            });
        }

        function saveChatHistory() {
            localStorage.setItem('chatHistory', JSON.stringify(chatHistory));
        }

        function saveFavorites() {
            localStorage.setItem('favorites', JSON.stringify(favorites));
        }

        function toggleFavorite(message) {
            const index = favorites.findIndex(fav => fav.text === message.text && fav.time === message.time);
            if (index === -1) {
                favorites.push(message);
                showToast(languageSelect.value === 'en' ? 'Added to favorites!' : 'ƒê√£ th√™m v√†o y√™u th√≠ch!');
            } else {
                favorites.splice(index, 1);
                showToast(languageSelect.value === 'en' ? 'Removed from favorites!' : 'ƒê√£ x√≥a kh·ªèi y√™u th√≠ch!');
            }
            saveFavorites();
            loadChatHistory();
        }

        function loadChatHistory() {
            const lang = languageSelect.value;
            chatMessages.innerHTML = '';
            chatHistory.forEach((msg, index) => {
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat-message ${msg.type}-message prose prose-invert max-w-none`;
                const textContent = typeof marked !== 'undefined' ? marked.parse(msg.text) : msg.text;
                const isFavorite = favorites.some(fav => fav.text === msg.text && fav.time === msg.time);
                const senderName = msg.type === 'user' ? (lang === 'en' ? 'You' : 'B·∫°n') : 'Beta AI ü§ñ';
                messageDiv.setAttribute('data-sender', senderName);
                messageDiv.innerHTML = msg.image ? `
                    <img src="${msg.image}" class="max-w-full h-auto rounded-lg mb-2" alt="User uploaded image">
                    ${textContent}
                    <div class="message-time">${msg.time}${msg.type === 'bot' ? `<button class="favorite-btn ${isFavorite ? 'favorite' : ''}" onclick="window.toggleFavoriteByIndex(${index})">‚òÖ</button>` : ''}</div>
                ` : `
                    ${textContent}
                    <div class="message-time">${msg.time}${msg.type === 'bot' ? `<button class="favorite-btn ${isFavorite ? 'favorite' : ''}" onclick="window.toggleFavoriteByIndex(${index})">‚òÖ</button>` : ''}</div>
                `;
                chatMessages.appendChild(messageDiv);
            });
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
        }

        function dataURLtoBlob(dataURL) {
            const [header, data] = dataURL.split(',');
            const mime = header.match(/:(.*?);/)[1];
            const binary = atob(data);
            const array = [];
            for (let i = 0; i < binary.length; i++) {
                array.push(binary.charCodeAt(i));
            }
            return new Blob([new Uint8Array(array)], { type: mime });
        }

        // X·ª≠ l√Ω s·ª± ki·ªán d√°n ·∫£nh
        chatInput.addEventListener('paste', (e) => {
            const items = (e.clipboardData || e.originalEvent.clipboardData).items;
            for (const item of items) {
                if (item.type.indexOf('image') !== -1) {
                    const file = item.getAsFile();
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        selectedImage = event.target.result;
                        imagePreview.src = selectedImage;
                        imagePreview.style.display = 'block';
                        showToast(languageSelect.value === 'en' ? 'Image pasted successfully!' : 'ƒê√£ d√°n ·∫£nh th√†nh c√¥ng!');
                    };
                    reader.readAsDataURL(file);
                    e.preventDefault(); // NgƒÉn ch·∫∑n d√°n n·ªôi dung kh√°c
                    break;
                }
            }
        });

        imageInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    selectedImage = event.target.result;
                    imagePreview.src = selectedImage;
                    imagePreview.style.display = 'block';
                    showToast(languageSelect.value === 'en' ? 'Image uploaded successfully!' : 'ƒê√£ t·∫£i ·∫£nh th√†nh c√¥ng!');
                };
                reader.readAsDataURL(file);
            } else {
                selectedImage = null;
                imagePreview.style.display = 'none';
            }
        });

        languageSelect.addEventListener('change', () => {
            updateLanguageUI();
            renderCodes();
        });

        async function sendMessage() {
            if (isProcessing) return;
            const message = chatInput.value.trim();
            if (!message && !selectedImage) return;

            isProcessing = true;
            sendBtn.disabled = true;
            chatInput.disabled = true;
            sendBtn.classList.add('loading');

            const lang = languageSelect.value;
            const time = new Date().toLocaleTimeString(lang === 'en' ? 'en-US' : 'vi-VN', { hour: '2-digit', minute: '2-digit' });
            const userMessage = { type: 'user', text: message, time, image: selectedImage };
            chatHistory.push(userMessage);

            const userMessageDiv = document.createElement('div');
            userMessageDiv.className = 'chat-message user-message prose prose-invert max-w-none';
            const userTextContent = typeof marked !== 'undefined' ? marked.parse(message) : message;
            userMessageDiv.setAttribute('data-sender', lang === 'en' ? 'You' : 'B·∫°n');
            userMessageDiv.innerHTML = selectedImage ? `
                <img src="${selectedImage}" class="max-w-full h-auto rounded-lg mb-2" alt="User uploaded image">
                ${userTextContent}
                <div class="message-time">${time}</div>
            ` : `
                ${userTextContent}
                <div class="message-time">${time}</div>
            `;
            chatMessages.appendChild(userMessageDiv);
            chatInput.value = '';
            imagePreview.style.display = 'none';
            selectedImage = null;
            imageInput.value = '';

            const typingIndicator = document.createElement('div');
            typingIndicator.className = 'typing-indicator';
            typingIndicator.textContent = lang === 'en' ? 'AI is thinking...' : 'AI ƒëang suy nghƒ©...';
            chatMessages.appendChild(typingIndicator);
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });

            try {
                const prompt = lang === 'en' ? `Please respond in English: ${message}` : message;
                const parts = [{ text: prompt }];
                if (selectedImage) {
                    const blob = dataURLtoBlob(selectedImage);
                    const arrayBuffer = await blob.arrayBuffer();
                    const base64String = btoa(String.fromCharCode(...new Uint8Array(arrayBuffer)));
                    parts.push({
                        inline_data: {
                            data: base64String,
                            mime_type: blob.type
                        }
                    });
                }

                const response = await fetch('https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=AIzaSyBfr7202t1xvByWLem6McWbD2O_Lh_NctE', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        contents: [{ parts }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Error ${response.status}: ${errorData.error.message || 'Cannot connect to Beta AI'}`);
                }

                const data = await response.json();
                if (!data.candidates || !data.candidates.length) {
                    throw new Error('No response from AI');
                }
                const botResponse = data.candidates[0].content.parts[0].text;
                const botMessage = { type: 'bot', text: botResponse, time };
                chatHistory.push(botMessage);

                typingIndicator.remove();
                const botMessageDiv = document.createElement('div');
                botMessageDiv.className = 'chat-message bot-message prose prose-invert max-w-none';
                const botTextContent = typeof marked !== 'undefined' ? marked.parse(botResponse) : botResponse;
                botMessageDiv.setAttribute('data-sender', 'Beta AI ü§ñ');
                botMessageDiv.innerHTML = `
                    ${botTextContent}
                    <div class="message-time">${time}<button class="favorite-btn" onclick="window.toggleFavoriteByIndex(${chatHistory.length - 1})">‚òÖ</button></div>
                `;
                chatMessages.appendChild(botMessageDiv);
                saveChatHistory();
                showToast(lang === 'en' ? 'Response received from AI!' : 'ƒê√£ nh·∫≠n ph·∫£n h·ªìi t·ª´ AI!');
            } catch (error) {
                typingIndicator.remove();
                const errorMessage = { type: 'bot', text: `Error: ${error.message}. Please check API key or network connection.`, time };
                chatHistory.push(errorMessage);

                const errorMessageDiv = document.createElement('div');
                errorMessageDiv.className = 'chat-message bot-message prose prose-invert max-w-none';
                const errorTextContent = typeof marked !== 'undefined' ? marked.parse(errorMessage.text) : errorMessage.text;
                errorMessageDiv.setAttribute('data-sender', 'Beta AI ü§ñ');
                errorMessageDiv.innerHTML = `
                    ${errorTextContent}
                    <div class="message-time">${time}<button class="favorite-btn" onclick="window.toggleFavoriteByIndex(${chatHistory.length - 1})">‚òÖ</button></div>
                `;
                chatMessages.appendChild(errorMessageDiv);
                saveChatHistory();
                showToast(lang === 'en' ? 'Error connecting to AI!' : 'L·ªói khi k·∫øt n·ªëi v·ªõi AI!');
            }

            isProcessing = false;
            sendBtn.disabled = false;
            chatInput.disabled = false;
            sendBtn.classList.remove('loading');
            chatMessages.scrollTo({ top: chatMessages.scrollHeight, behavior: 'smooth' });
        }

        // Initialize
        renderCodes();
        updateLanguageUI();
        loadChatHistory();
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !isProcessing) {
                sendMessage();
            }
        });
    </script>
</body>
</html>
